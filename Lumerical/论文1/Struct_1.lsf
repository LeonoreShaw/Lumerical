## Lumerical Script实现论文1结构
#圆偏振结构需要固定尺寸r1、r2，并使用旋转角Theta
selectall;
delete;
nm=1e-9;#纳米单位
um=1e-6;   #微米单位 
N = 11;M =11;#循环数
S = 1.5*um;
L = 0.34*um;
#椭圆第一与第二半径的初始数据
r1=[[0.68,0.39],
[0.6,0.49],
[0.51,0.41],
[0.43,0.17],
[0.32,0.3],
[0.23,0.33],
[0.37,0.32],
[0.5,0.48],
[0.68,0.43],
[0.54,0.51],
[0.51,0.59]];


r2=[[0.39,0.42],
[0.5,0.25],
[0.38,0.45],
[0.64,0.54],
[0.44,0.45],
[0.7,0.37],
[0.33,0.14],
[0.6,0.49],
[0.6,0.57],
[0.5,0.67],
[0.42,0.35]];


r3=[[0.6,0.5],
[0.13,0.17],
[0.53,0.4],
[0.65,0.24],
[0.43,0.37],
[0.48,0.32],
[0.14,0.7],
[0.66,0.42],
[0.67,0.45],
[0.62,0.65],
[0.42,0.46]];


r4=[[0.49,0.25],
[0.17,0.49],
[0.41,0.69],
[0.38,0.6],
[0.46,0.62],
[0.53,0.5],
[0.6,0.66],
[0.55,0.68],
[0.61,0.64],
[0.39,0.57],
[0.42,0.42]];


r5=[[0.51,0.38],
[0.53,0.41],
[0.63,0.35],
[0.18,0.44],
[0.69,0.18],
[0.39,0.48],
[0.49,0.42],
[0.68,0.67],
[0.69,0.58],
[0.67,0.57],
[0.58,0.7]];


r6=[[0.41,0.45],
[0.4,0.69],
[0.35,0.54],
[0.39,0.63],
[0.46,0.52],
[0.38,0.68],
[0.6,0.67],
[0.61,0.69],
[0.5,0.57],
[0.7,0.32],
[0.46,0.68]];


r7=[[0.43,0.64],
[0.65,0.38],
[0.18,0.39],
[0.42,0.37],
[0.23,0.58],
[0.7,0.43],
[0.57,0.45],
[0.64,0.58],
[0.57,0.64],
[0.42,0.59],
[0.39,0.29]];


r8=[[0.17,0.54],
[0.24,0.6],
[0.44,0.63],
[0.37,0.22],
[0.43,0.66],
[0.5,0.54],
[0.5,0.62],
[0.39,0.67],
[0.7,0.42],
[0.68,0.66],
[0.35,0.52]];


r9=[[0.32,0.44],
[0.43,0.46],
[0.69,0.46],
[0.23,0.43],
[0.52,0.32],
[0.39,0.51],
[0.67,0.65],
[0.57,0.57],
[0.32,0.59],
[0.66,0.39],
[0.55,0.7]];


r10=[[0.3,0.45],
[0.37,0.62],
[0.18,0.52],
[0.58,0.66],
[0.32,0.38],
[0.58,0.51],
[0.42,0.42],
[0.42,0.58],
[0.46,0.39],
[0.35,0.55],
[0.47,0.37]];


r11=[[0.23,0.7],
[0.48,0.53],
[0.39,0.38],
[0.7,0.5],
[0.39,0.58],
[0.5,0.59],
[0.35,0.46],
[0.42,0.7],
[0.68,0.29],
[0.52,0.7],
[0.37,0.53]];

#椭圆半径数据存放进r
r = randmatrix(11,11,2);
r(1,:,:)=r1;
r(2,:,:)=r2;
r(3,:,:)=r3;
r(4,:,:)=r4;
r(5,:,:)=r5;
r(6,:,:)=r6;
r(7,:,:)=r7;
r(8,:,:)=r8;
r(9,:,:)=r9;
r(10,:,:)=r10;
r(11,:,:)=r11;

r1 = 0.49;
r2 = 0.34;

#旋转角度θ
Theta=[[0.0 ,8.704240664790067 ,34.75204568423299 ,77.95106111265105 ,137.98848345833275 ,214.44205752753766 ,306.79421266025423 ,54.44829304853458 ,176.74579574872732 ,312.9836049736165 ,102.43037322507331];
[8.704240664790067 ,17.397634911127707 ,43.413142354179236 ,86.55911929739155 ,146.52389845003486 ,222.8867212239734 ,315.1317926439426 ,62.664422723916324 ,184.82817583085426 ,320.92202326069724 ,110.2166543378526];
[34.75204568423299 ,43.413142354179236 ,69.33247318131845 ,112.32049920442016 ,172.06892079765578 ,248.16141657568295 ,340.08745821783054 ,87.25818906328504 ,209.0233112924681 ,344.6879965125349 ,133.52898912746437];
[77.95106111265105 ,86.55911929739155 ,112.32049920442016 ,155.04908525217476 ,214.44205752753766 ,290.09031886439755 ,21.491922099130836 ,128.06752379203613 ,249.17684664711956 ,24.135197055789206 ,172.22922999532616];
[137.98848345833275 ,146.52389845003486 ,172.06892079765578 ,214.44205752753766 ,273.3478922879517 ,348.38709677419354 ,79.0693404860787 ,184.82817583085426 ,305.0369303945726 ,79.02469496019039 ,226.09163027651022];
[214.44205752753766 ,222.8867212239734 ,248.16141657568295 ,290.09031886439755 ,348.38709677419354 ,62.664422723916324 ,152.44625737761217 ,257.1820456914267 ,16.261915643760947 ,149.03201905687192 ,294.8092750843667];
[306.79421266025423 ,315.1317926439426 ,340.08745821783054 ,21.491922099130836 ,79.0693404860787 ,152.44625737761217 ,241.16318096531222 ,344.6879965125349 ,102.43037322507331 ,233.756361918863 ,18.002487105446647];
[54.44829304853458 ,62.664422723916324 ,87.25818906328504 ,128.06752379203613 ,184.82817583085426 ,257.1820456914267 ,344.6879965125349 ,86.83441702422847 ,203.05276460555834 ,332.73134701873886 ,115.22869352824551];
[176.74579574872732 ,184.82817583085426 ,209.0233112924681 ,249.17684664711956 ,305.0369303945726 ,16.261915643760947 ,102.43037322507331 ,203.05276460555834 ,317.5840751755753 ,85.43673053100193 ,225.99319612964518];
[312.9836049736165 ,320.92202326069724 ,344.6879965125349 ,24.135197055789206 ,79.02469496019039 ,149.03201905687192 ,233.756361918863 ,332.73134701873886 ,85.43673053100193 ,211.31042478714434 ,349.7602946125586];
[102.43037322507331 ,110.2166543378526 ,133.52898912746437 ,172.22922999532616 ,226.09163027651022 ,294.8092750843667 ,18.002487105446647 ,115.22869352824551 ,225.99319612964518 ,349.7602946125586 ,125.96426518010503]];

Theta = -Theta/2;


    #以下脚本命令将创建[M,N]个名为“cylinderi_j”的圆，其半径为5 um，
    #以（x，y，z）为中心位置。该圆的厚度（z跨度）为L微米。定义第二个半径为1
for (i=1:N){ 
for(j=1:M){
    x = (j-1)*S; y=(i-1)*S;
    addcircle;      
    name = "cylinder"+num2str(i)+"_"+num2str(j);
    set("name",name);
    set("material","Si (Silicon) - Palik");#材料为硅
    set("x",x);                              #设置x中心点坐标 
    set("y",y);                            #设置y中心点坐标 
    set("z min",0);#设置z方向最小值
    set("z max",L);#设置z方向最大值
    set("make ellipsoid",1);
#    setnamed(name,"radius", r(i,j,2)*um );
#    setnamed(name,"radius 2", r(i,j,1)*um );
    setnamed(name,"radius", r1*um );
    setnamed(name,"radius 2", r2*um );
#    set("first axis","z");    # 指定旋转轴为z轴
#    set("rotation 1",Theta(i,j));  # 旋转 Theta角（degree）
    row = "row_"+num2str(i);
    #将选定的对象添加到组中。如果名称为“ group_name”的组已存在，
    #则将对象添加到现有组。否则，将创建一个名为“ group_name”的组。
    addtogroup("surface");
    addtogroup("surface_1");
    addtogroup(row);
    
}
}          
for (i=1:N){ 
for(j=1:M){
    x = -1*(j-1)*S; y=-1*(i-1)*S;
    addcircle;
    
    name = "cylinder"+num2str(i)+"_"+num2str(j);
    set("name",name);
    set("material","Si (Silicon) - Palik");
    set("x",x);   
    set("y",y);
    set("z min",0);
    set("z max",L);
    set("make ellipsoid",1);
    
#    setnamed(name,"radius", r(i,j,2)*um );
#    setnamed(name,"radius 2", r(i,j,1)*um );
    setnamed(name,"radius", r1*um );
    setnamed(name,"radius 2", r2*um );
#    set("first axis","z");    # 指定旋转轴为z轴
#    set("rotation 1",Theta(i,j));  # 旋转 Theta角（degree）
    row = "row_"+num2str(i);
    addtogroup("surface");
    addtogroup("surface_3");
    addtogroup(row);
    if(i==1&j==1){
        delete;}
    
}
}
for (i=2:N){ 
for(j=2:M){
    x = 1*(j-1)*S; y=-1*(i-1)*S;
    addcircle;
    name = "cylinder"+num2str(i)+"_"+num2str(j);
    set("name",name);
    set("material","Si (Silicon) - Palik");
    set("x",x);   
    set("y",y);
    set("z min",0);
    set("z max",L);
    set("make ellipsoid",1);
    
#    setnamed(name,"radius", r(i,j,2)*um );
#    setnamed(name,"radius 2", r(i,j,1)*um );
    setnamed(name,"radius", r1*um );
    setnamed(name,"radius 2", r2*um );
#    set("first axis","z");    # 指定旋转轴为z轴
#    set("rotation 1",Theta(i,j));  # 旋转 Theta角（degree）
    row = "row_"+num2str(i);
    addtogroup("surface");
    addtogroup("surface_4");
    addtogroup(row);
    
}
}
for (i=2:N){ 
for(j=2:M){
    x = -1*(j-1)*S; y=1*(i-1)*S;
    addcircle;
    name = "cylinder"+num2str(i)+"_"+num2str(j);
    set("name",name);
    set("material","Si (Silicon) - Palik");
    set("x",x);   
    set("y",y);
    set("z min",0);
    set("z max",L);
    set("make ellipsoid",1);
    
#    setnamed(name,"radius", r(i,j,2)*um );
#    setnamed(name,"radius 2", r(i,j,1)*um );
    setnamed(name,"radius", r1*um );
    setnamed(name,"radius 2", r2*um );
#    set("first axis","z");    # 指定旋转轴为z轴
#    set("rotation 1",Theta(i,j));  # 旋转 Theta角（degree）
    row = "row_"+num2str(i);
    addtogroup("surface");
    addtogroup("surface_2");
    addtogroup(row);
    
}
}

#---------------------------------添加结构-------------------------------------------------------
#----------------------------------------------------------------------------------------

## %%



# 长方体衬底 Rectangle


addrect;
set("name","Rectangle");#名称                   
set("material","SiO2 (Glass) - Palik");#材料
#set("render type","wireframe");   # 渲染方式：线框，减小显卡压力,默认为detailed
set("x",0);#设置x中心点坐标   
set("y",0);#设置y中心点坐标
set("x span",40*um);#设置x方向宽度
set("y span",40*um);#设置y方向宽度
set("z max",0);#设置z方向最大值
set("z min",-0.2*um);#设置z方向最小值





# FDTD


addfdtd;
set("dimension",2);#三维仿真区域
set("simulation time",3e-11);#30000fs
set("x",0);
set("y",0);
set("z min",-0.5*um);
set("z max",35*um);
set("x span",35*um);
set("y span",35*um);
#set("x min bc","periodic");#设置x方向周期边界条件
#set("y min bc","periodic");#设置y方向周期边界条件
#set("Mesh type","auto non-uniform");#仿真网格为自动精度
set("Mesh accuracy",1);#低精度








# Source  (Plane wave）


addplane;
#set("injection axis","z");#基准轴
#set("direction","backward");#入射方向
set("x",0);
set("x span",40*um);
set("y",0);
set("y span",40*um);
set("z",-0.02*um);
set("wavelength start",1.55*um);#起始波长
set("wavelength stop",1.55*um);#截止波长
#set("amplitude",1);#振幅，默认为1，无特殊需要可不设置
#set("phase",0);#初始相位，角度制，默认为0，无特殊需要可不设置
#set("angle theta",30);#入射角theta
#set("angle phi",0);#入射角phi
#set("polarization angle",90);#偏振角









#Monitor  Frequency-domain field profile


addprofile;
set("name","30");
set("monitor type","2D Z-normal");#xy面监视器
set("x",0);
set("x span",40*um);
set("y",0);
set("y span",40*um);
set("z",30*um);













