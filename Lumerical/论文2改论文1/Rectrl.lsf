selectall;
delete;
nm=1e-9;
um=1e-6;
N = 5;M =20;
S = 0.9*um;
L = 1.2*um;

r1=[
0.44 , 0.27 ;
0.26 , 0.29 ;
0.24 , 0.56 ;
0.52 , 0.25 ;
0.27 , 0.28 ;
0.23 , 0.6 ;
0.39 , 0.16 ;
0.16 , 0.39 ;
0.49 , 0.57 ;
0.57 , 0.24 ;
0.57 , 0.24 ;
0.49 , 0.57 ;
0.16 , 0.39 ;
0.39 , 0.16 ;
0.23 , 0.6 ;
0.27 , 0.28 ;
0.52 , 0.25 ;
0.24 , 0.56 ;
0.26 , 0.29 ;
0.44 , 0.27 ];
r2=[
0.41 , 0.28 ;
0.6 , 0.23 ;
0.23 , 0.6 ;
0.16 , 0.39 ;
0.26 , 0.29 ;
0.3 , 0.25 ;
0.25 , 0.52 ;
0.12 , 0.59 ;
0.2 , 0.34 ;
0.49 , 0.57 ;
0.49 , 0.57 ;
0.2 , 0.34 ;
0.12 , 0.59 ;
0.25 , 0.52 ;
0.3 , 0.25 ;
0.26 , 0.29 ;
0.16 , 0.39 ;
0.23 , 0.6 ;
0.6 , 0.23 ;
0.41 , 0.28 ];
r3=[
0.38 , 0.29 ;
0.49 , 0.57 ;
0.29 , 0.26 ;
0.1 , 0.57 ;
0.6 , 0.23 ;
0.28 , 0.27 ;
0.24 , 0.56 ;
0.44 , 0.27 ;
0.12 , 0.49 ;
0.16 , 0.39 ;
0.16 , 0.39 ;
0.12 , 0.49 ;
0.44 , 0.27 ;
0.24 , 0.56 ;
0.28 , 0.27 ;
0.6 , 0.23 ;
0.1 , 0.57 ;
0.29 , 0.26 ;
0.49 , 0.57 ;
0.38 , 0.29 ];
r4=[
0.34 , 0.31 ;
0.12 , 0.59 ;
0.27 , 0.28 ;
0.57 , 0.26 ;
0.52 , 0.25 ;
0.26 , 0.29 ;
0.29 , 0.26 ;
0.38 , 0.29 ;
0.41 , 0.28 ;
0.44 , 0.27 ;
0.44 , 0.27 ;
0.41 , 0.28 ;
0.38 , 0.29 ;
0.29 , 0.26 ;
0.26 , 0.29 ;
0.52 , 0.25 ;
0.57 , 0.26 ;
0.27 , 0.28 ;
0.12 , 0.59 ;
0.34 , 0.31 ];
r5=[
0.26 , 0.29 ;
0.41 , 0.28 ;
0.56 , 0.24 ;
0.29 , 0.26 ;
0.44 , 0.27 ;
0.2 , 0.34 ;
0.26 , 0.29 ;
0.58 , 0.54 ;
0.35 , 0.3 ;
0.36 , 0.3 ;
0.36 , 0.3 ;
0.35 , 0.3 ;
0.58 , 0.54 ;
0.26 , 0.29 ;
0.2 , 0.34 ;
0.44 , 0.27 ;
0.29 , 0.26 ;
0.56 , 0.24 ;
0.41 , 0.28 ;
0.26 , 0.29 ];

#r8 = [[0.45 , 0.235],
        #[0.36 , 0.28 ],
        #[0.575, 0.345],
        #[0.49 , 0.485],
        #[0.495, 0.465],
        #[0.54 , 0.405],
        #[0.395, 0.515],
        #[0.595, 0.325]];

r = randmatrix(5,20,2);
r(1,:,:)=r1;
r(2,:,:)=r2;
r(3,:,:)=r3;
r(4,:,:)=r4;
r(5,:,:)=r5;
#first#
r1 = 0.415;
r2 = 0.54;

#second#
#r1 = 0.545;
#r2 = 0.395;
#r1 = 0.475;
#r2 = 0.39;
Theta=[
-44.509573328268964 ,
-24.509162084013273 ,
-3.4388672765760964 ,
-71.34861170833172 ,
-48.31108999196472 ,
-24.422152148628477 ,
0.19991223426267357 ,
-64.58372432397881 ,
-38.92935136723974 ,
-13.006588059269642 ,
13.006588059269642 ,
38.92935136723974 ,
64.58372432397881 ,
-0.19991223426267357 ,
24.422152148628477 ,
48.31108999196472 ,
71.34861170833172 ,
3.4388672765760964 ,
24.509162084013273 ,
44.509573328268964 ;


-44.04750189910452 ,
-24.073521454023574 ,
-3.035650403397059 ,
-70.98384208891086 ,
-47.990622361378406 ,
-24.151455043301425 ,
0.41597887466700456 ,
-64.42632742398327 ,
-38.83365695052855 ,
-12.974477380175962 ,
12.974477380175962 ,
38.83365695052855 ,
64.42632742398327 ,
-0.41597887466700456 ,
24.151455043301425 ,
47.990622361378406 ,
70.98384208891086 ,
3.035650403397059 ,
24.073521454023574 ,
44.04750189910452 ;


-43.13195963148322 ,
-23.210615847635914 ,
-2.2371997671765875 ,
-70.26171558293247 ,
-47.356348682391385 ,
-23.615796122024314 ,
0.8434634279147102 ,
-64.11495954291102 ,
-38.64436723463202 ,
-12.910963133628815 ,
12.910963133628815 ,
38.64436723463202 ,
64.11495954291102 ,
-0.8434634279147102 ,
23.615796122024314 ,
47.356348682391385 ,
70.26171558293247 ,
2.2371997671765875 ,
23.210615847635914 ,
43.13195963148322 ;


-41.77970291887844 ,
-21.936750066496444 ,
-1.059044246343902 ,
-69.19664168511922 ,
-46.4212104853806 ,
-22.826311669250185 ,
1.4733431740202385 ,
-63.656267940115335 ,
-38.36555423730063 ,
-12.817416878214662 ,
12.817416878214662 ,
38.36555423730063 ,
63.656267940115335 ,
-1.4733431740202385 ,
22.826311669250185 ,
46.4212104853806 ,
69.19664168511922 ,
1.059044246343902 ,
21.936750066496444 ,
41.77970291887844 ;


49.98520073672271 ,
-20.27531139924051 ,
0.4765696377855222 ,
22.190760021061084 ,
-45.20370829989572 ,
-21.798908025399896 ,
2.292739545736807 ,
26.940264401045248 ,
-38.00302505388594 ,
-12.695794244233017 ,
12.695794244233017 ,
38.00302505388594 ,
-26.940264401045248 ,
-2.292739545736807 ,
21.798908025399896 ,
45.20370829989572 ,
-22.190760021061084 ,
-0.4765696377855222 ,
20.27531139924051 ,
-49.98520073672271


];
for (i=1:N){ 
for(j=1:M){
    x = (j-1)*S; y=(i-1)*S+0.45*um;
    addrect;
    name = "rect"+num2str(i)+"_"+num2str(j);
    set("name",name);#名称              
    set("material","Si (Silicon) - Palik");#材料
    #set("render type","wireframe");   # 渲染方式：线框，减小显卡压力
    set("x",x);#设置x中心点坐标   
    set("y",y);#设置y中心点坐标
    set("x span",r(i,j,2)*um );#设置x方向宽度
    set("y span",r(i,j,1)*um );#设置y方向宽度     
    #set("z max",1e-7);#设置z方向最大值
    #set("z min",-1e-6);#设置z方向最小值
    set("z min",0);
    set("z max",L);
    #set("first axis","x");#设置第一转轴
    #set("rotation 1",45);#设置第一旋转角
    hang = "hang_"+num2str(i);
    addtogroup("surface");
    addtogroup("surface_1");
    addtogroup(hang);
    
    
    
    #name = "circle"+num2str(i)+"_"+num2str(j);
    #set("name",name);
    #set("material","Si (Silicon) - Palik");
    #set("x",x);   
    #set("y",y);
    #set("z min",0);
    #set("z max",L);
    #set("make ellipsoid",1);
    #setnamed(name,"radius", r(i,j,1)*um );
    #setnamed(name,"radius 2", r(i,j,2)*um );
##    setnamed(name,"radius", r1*um );
##    setnamed(name,"radius 2", r2*um );
    set("first axis","z");    # 指定旋转轴为z轴
    set("rotation 1",Theta(i,j));  # 旋转 Theta角（degree）
    #hang = "hang_"+num2str(i);
    #addtogroup("surface");
    #addtogroup("surface_1");
    #addtogroup(hang);
    
}
}


for(i=1:N){ 
for(j=1:M){
    x = 1*(j-1)*S; y=-1*(i-1)*S-0.45*um;
    addrect;
    name = "rect"+num2str(i)+"_"+num2str(j);
    set("name",name);#名称              
    set("material","Si (Silicon) - Palik");#材料
    #set("render type","wireframe");   # 渲染方式：线框，减小显卡压力
    set("x",x);#设置x中心点坐标   
    set("y",y);#设置y中心点坐标
    set("x span",r(i,j,2)*um );#设置x方向宽度
    set("y span",r(i,j,1)*um );#设置y方向宽度     
    #set("z max",1e-7);#设置z方向最大值
    #set("z min",-1e-6);#设置z方向最小值
    set("z min",0);
    set("z max",L);
    #set("first axis","x");#设置第一转轴
    #set("rotation 1",45);#设置第一旋转角
#    setnamed(name,"radius", r1*um );
#    setnamed(name,"radius 2", r2*um );
    set("first axis","z");    # 指定旋转轴为z轴
    set("rotation 1",Theta(i,j));  # 旋转 Theta角（degree）
    hang = "hang_"+num2str(i);
    addtogroup("surface");
    addtogroup("surface_4");
    addtogroup(hang);
#    if(i==1&j==1){
#        delete;}
    
}
}

#---------------------------------添加结构-------------------------------------------------------
#----------------------------------------------------------------------------------------

## %%



# 长方体衬底 Rectangle


addrect;
set("name","Rectangle");#名称                   
set("material","SiO2 (Glass) - Palik");#材料
#set("render type","wireframe");   # 渲染方式：线框，减小显卡压力,默认为detailed
set("x",8.55*um);#设置x中心点坐标   
set("y",0);#设置y中心点坐标
set("x span",22*um);#设置x方向宽度
set("y span",12*um);#设置y方向宽度
set("z max",0);#设置z方向最大值
set("z min",-0.2*um);#设置z方向最小值





# FDTD


addfdtd;
set("dimension",2);#三维仿真区域
set("simulation time",3e-11);#30000fs
set("x",8.55*um);
set("y",0);
set("z min",-0.5*um);
set("z max",20*um);
set("x span",20*um);
set("y span",10*um);
#set("x min bc","periodic");#设置x方向周期边界条件
#set("y min bc","periodic");#设置y方向周期边界条件
#set("Mesh type","auto non-uniform");#仿真网格为自动精度
set("Mesh accuracy",1);#低精度








# Source  (Plane wave）


#addplane;
##set("injection axis","z");#基准轴
##set("direction","backward");#入射方向
#set("x",8.55*um);
#set("x span",22*um);
#set("y",0);
#set("y span",12*um);
#set("z",-0.02*um);
#set("wavelength start",1.55*um);#起始波长
#set("wavelength stop",1.55*um);#截止波长
##set("amplitude",1);#振幅，默认为1，无特殊需要可不设置
##set("phase",0);#初始相位，角度制，默认为0，无特殊需要可不设置
##set("angle theta",30);#入射角theta
##set("angle phi",0);#入射角phi
##set("polarization angle",90);#偏振角




addplane;
set("name","x");
#set("injection axis","z");#基准轴
#set("direction","backward");#入射方向
set("x",8.55*um);
set("x span",22*um);
set("y",0);
set("y span",12*um);
set("z",-0.02*um);
set("wavelength start",1.55*um);#起始波长
set("wavelength stop",1.55*um);#截止波长
#set("amplitude",1);#振幅，默认为1，无特殊需要可不设置
#set("phase",0);#初始相位，角度制，默认为0，无特殊需要可不设置
#set("angle theta",30);#入射角theta
#set("angle phi",0);#入射角phi
#set("polarization angle",90);#偏振角

addplane;
set("name","y");
#set("injection axis","z");#基准轴
#set("direction","backward");#入射方向
set("x",8.55*um);
set("x span",22*um);
set("y",0);
set("y span",12*um);
set("z",-0.02*um);
set("wavelength start",1.55*um);#起始波长
set("wavelength stop",1.55*um);#截止波长
#set("amplitude",1);#振幅，默认为1，无特殊需要可不设置
set("phase",-90);#初始相位，角度制，默认为0，无特殊需要可不设置
#set("angle theta",30);#入射角theta
#set("angle phi",0);#入射角phi
set("polarization angle",90);#偏振角




 



#Monitor  Frequency-domain field profile


addprofile;
set("name","z=17.5");
set("monitor type","2D Z-normal");#xy面监视器
set("x",8.55*um);
set("x span",22*um);
set("y",0);
set("y span",12*um);
set("z",17.5*um);

addprofile;
set("name","z=14.3565");
set("monitor type","2D Z-normal");#xy面监视器
set("x",8.55*um);
set("x span",22*um);
set("y",0);
set("y span",12*um);
set("z",14.3565*um);

addprofile;
set("name","y=0");
set("monitor type","2D Y-normal");#xz面监视器
set("x",8.55*um);
set("x span",22*um);
set("y",0);
set("z min",-1*um);
set("z max",22*um);

