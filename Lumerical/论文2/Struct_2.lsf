##Lumerical脚本实现论文2圆偏振结构，其他结构方法相似
selectall;
delete;
nm=1e-9;
um=1e-6;
N = 5;M =20;
S = 0.48*um;
L = 0.65*um;

r1=[
0.186 , 0.138 ;
0.158 , 0.158 ;
0.142 , 0.18 ;
0.172 , 0.146 ;
0.158 , 0.158 ;
0.146 , 0.172 ;
0.194 , 0.134 ;
0.178 , 0.142 ;
0.172 , 0.146 ;
0.168 , 0.148 ;
0.168 , 0.148 ;
0.172 , 0.146 ;
0.178 , 0.142 ;
0.194 , 0.134 ;
0.146 , 0.172 ;
0.158 , 0.158 ;
0.172 , 0.146 ;
0.142 , 0.18 ;
0.158 , 0.158 ;
0.186 , 0.138 ];
r2=[
0.19 , 0.136 ;
0.16 , 0.156 ;
0.144 , 0.176 ;
0.174 , 0.144 ;
0.158 , 0.158 ;
0.148 , 0.168 ;
0.14 , 0.184 ;
0.184 , 0.14 ;
0.174 , 0.144 ;
0.172 , 0.146 ;
0.172 , 0.146 ;
0.174 , 0.144 ;
0.184 , 0.14 ;
0.14 , 0.184 ;
0.148 , 0.168 ;
0.158 , 0.158 ;
0.174 , 0.144 ;
0.144 , 0.176 ;
0.16 , 0.156 ;
0.19 , 0.136 ];
r3=[
0.208 , 0.128 ;
0.164 , 0.152 ;
0.148 , 0.168 ;
0.184 , 0.14 ;
0.164 , 0.152 ;
0.154 , 0.162 ;
0.144 , 0.174 ;
0.194 , 0.134 ;
0.184 , 0.14 ;
0.18 , 0.142 ;
0.18 , 0.142 ;
0.184 , 0.14 ;
0.194 , 0.134 ;
0.144 , 0.174 ;
0.154 , 0.162 ;
0.164 , 0.152 ;
0.184 , 0.14 ;
0.148 , 0.168 ;
0.164 , 0.152 ;
0.208 , 0.128 ];
r4=[
0.218 , 0.296 ;
0.174 , 0.144 ;
0.156 , 0.16 ;
0.206 , 0.13 ;
0.174 , 0.144 ;
0.16 , 0.156 ;
0.152 , 0.164 ;
0.226 , 0.124 ;
0.206 , 0.13 ;
0.194 , 0.134 ;
0.194 , 0.134 ;
0.206 , 0.13 ;
0.226 , 0.124 ;
0.152 , 0.164 ;
0.16 , 0.156 ;
0.174 , 0.144 ;
0.206 , 0.13 ;
0.156 , 0.16 ;
0.174 , 0.144 ;
0.218 , 0.296 ];
r5=[
0.236 , 0.258 ;
0.194 , 0.134 ;
0.164 , 0.152 ;
0.252 , 0.28 ;
0.19 , 0.136 ;
0.172 , 0.146 ;
0.16 , 0.156 ;
0.154 , 0.162 ;
0.258 , 0.278 ;
0.214 , 0.3 ;
0.214 , 0.3 ;
0.258 , 0.278 ;
0.154 , 0.162 ;
0.16 , 0.156 ;
0.172 , 0.146 ;
0.19 , 0.136 ;
0.252 , 0.28 ;
0.164 , 0.152 ;
0.194 , 0.134 ;
0.236 , 0.258 ];

r = randmatrix(5,20,2);
r(1,:,:)=r1;
r(2,:,:)=r2;
r(3,:,:)=r3;
r(4,:,:)=r4;
r(5,:,:)=r5;

Theta=[
-33.570713908044176 ,
-14.396989249919695 ,
5.7562524161816455 ,
-63.15969789858608 ,
-41.213695808778745 ,
-18.4949446443975 ,
-85.11225737735998 ,
-61.19231542639003 ,
-36.87694084153179 ,
-12.319484620398839 ,
12.319484620398839 ,
36.87694084153179 ,
61.19231542639003 ,
85.11225737735998 ,
18.4949446443975 ,
41.213695808778745 ,
63.15969789858608 ,
-5.7562524161816455 ,
14.396989249919695 ,
33.570713908044176 ;


-33.15045432797532 ,
-14.00163175757637 ,
6.121440095622117 ,
-62.82994526385975 ,
-40.92447121943706 ,
-18.25098556743189 ,
5.082240298962059 ,
-61.05075707635822 ,
-36.79092783388872 ,
-12.2906313482463 ,
12.2906313482463 ,
36.79092783388872 ,
61.05075707635822 ,
-5.082240298962059 ,
18.25098556743189 ,
40.92447121943706 ,
62.82994526385975 ,
-6.121440095622117 ,
14.00163175757637 ,
33.15045432797532 ;


-32.31740877324426 ,
-13.218169770006206 ,
6.844924477798377 ,
-62.17682012064937 ,
-40.35174104267082 ,
-17.767980499827686 ,
5.467260393167392 ,
-60.770566046964696 ,
-36.62069280913278 ,
-12.233527846109007 ,
12.233527846109007 ,
36.62069280913278 ,
60.770566046964696 ,
-5.467260393167392 ,
17.767980499827686 ,
40.35174104267082 ,
62.17682012064937 ,
-6.844924477798377 ,
13.218169770006206 ,
32.31740877324426 ;


-31.0861553504463 ,
-12.060740453253752 ,
7.913283349352581 ,
-61.21274184781336 ,
-39.50663157241524 ,
-17.055483325157425 ,
6.035075666963364 ,
-60.357427696439714 ,
-36.369715457629894 ,
-12.149345640818161 ,
12.149345640818161 ,
36.369715457629894 ,
60.357427696439714 ,
-6.035075666963364 ,
17.055483325157425 ,
39.50663157241524 ,
61.21274184781336 ,
-7.913283349352581 ,
12.060740453253752 ,
31.0861553504463 ;


-29.477674020574444 ,
-10.54966400547174 ,
9.307246242618456 ,
-59.95552265746816 ,
-38.40508587314538 ,
-16.127173320401873 ,
6.774629247816656 ,
30.180526735526364 ,
-36.042970846251244 ,
-12.039759443474281 ,
12.039759443474281 ,
36.042970846251244 ,
-30.180526735526364 ,
-6.774629247816656 ,
16.127173320401873 ,
38.40508587314538 ,
59.95552265746816 ,
-9.307246242618456 ,
10.54966400547174 ,
29.477674020574444];

#Theta = Theta/2;

for (i=1:N){ 
for(j=1:M){
    x = (j-1)*S; y=(i-1)*S+0.24*um;
    addrect;
    name = "rect"+num2str(i)+"_"+num2str(j);
    set("name",name);#名称              
    set("material","Si (Silicon) - Palik");#材料
    #set("render type","wireframe");   # 渲染方式：线框，减小显卡压力
    set("x",x);#设置x中心点坐标   
    set("y",y);#设置y中心点坐标
    set("x span",r(i,j,1)*um );#设置x方向宽度
    set("y span",r(i,j,2)*um );#设置y方向宽度     
    #set("z max",1e-7);#设置z方向最大值
    #set("z min",-1e-6);#设置z方向最小值
    set("z min",0);
    set("z max",L);
    set("first axis","z");#设置第一转轴
    set("rotation 1",Theta(i,j));#设置第一旋转角
    hang = "hang_"+num2str(i);
    addtogroup("surface");
    addtogroup("surface_1");
    addtogroup(hang);   
}
}


for(i=1:N){ 
for(j=1:M){
    x = 1*(j-1)*S; y=-1*(i-1)*S-0.24*um;
    addrect;
    name = "rect"+num2str(i)+"_"+num2str(j);
    set("name",name);#名称              
    set("material","Si (Silicon) - Palik");#材料
    #set("render type","wireframe");   # 渲染方式：线框，减小显卡压力
    set("x",x);#设置x中心点坐标   
    set("y",y);#设置y中心点坐标
    set("x span",r(i,j,1)*um );#设置x方向宽度
    set("y span",r(i,j,2)*um );#设置y方向宽度     
    #set("z max",1e-7);#设置z方向最大值
    #set("z min",-1e-6);#设置z方向最小值
    set("z min",0);
    set("z max",L);
    #set("first axis","x");#设置第一转轴
    #set("rotation 1",45);#设置第一旋转角
    set("first axis","z");    # 指定旋转轴为z轴
    set("rotation 1",Theta(i,j));  # 旋转 Theta角（degree）
    hang = "hang_"+num2str(i);
    addtogroup("surface");
    addtogroup("surface_4");
    addtogroup(hang);   
}
}

#---------------------------------添加结构-------------------------------------------------------
#----------------------------------------------------------------------------------------

## %%



# 长方体衬底 Rectangle


addrect;
set("name","Rectangle");#名称                   
set("material","SiO2 (Glass) - Palik");#材料
#set("render type","wireframe");   # 渲染方式：线框，减小显卡压力,默认为detailed
set("x",4.56*um);#设置x中心点坐标   
set("y",0);#设置y中心点坐标
set("x span",12*um);#设置x方向宽度
set("y span",12*um);#设置y方向宽度
set("z max",0);#设置z方向最大值
set("z min",-0.2*um);#设置z方向最小值





# FDTD


addfdtd;
set("dimension",2);#三维仿真区域
set("simulation time",3e-11);#30000fs
set("x",4.56*um);
set("y",0);
set("z min",-0.5*um);
set("z max",12*um);
set("x span",9.6*um);
set("y span",9.6*um);
#set("x min bc","periodic");#设置x方向周期边界条件
#set("y min bc","periodic");#设置y方向周期边界条件
#set("Mesh type","auto non-uniform");#仿真网格为自动精度
set("Mesh accuracy",1);#低精度








# Source  (Plane wave）


addplane;
#set("injection axis","z");#基准轴
#set("direction","backward");#入射方向
set("x",4.56*um);
set("x span",12*um);
set("y",0);
set("y span",12*um);
set("z",-0.02*um);
set("wavelength start",0.85*um);#起始波长
set("wavelength stop",0.85*um);#截止波长
#set("amplitude",1);#振幅，默认为1，无特殊需要可不设置
#set("phase",0);#初始相位，角度制，默认为0，无特殊需要可不设置
#set("angle theta",30);#入射角theta
#set("angle phi",0);#入射角phi
#set("polarization angle",90);#偏振角

addplane;
set("name","source-90");
#set("injection axis","z");#基准轴
#set("direction","backward");#入射方向
set("x",4.56*um);
set("x span",12*um);
set("y",0);
set("y span",12*um);
set("z",-0.02*um);
set("wavelength start",0.85*um);#起始波长
set("wavelength stop",0.85*um);#截止波长
#set("amplitude",1);#振幅，默认为1，无特殊需要可不设置
#set("phase",0);#初始相位，角度制，默认为0，无特殊需要可不设置
#set("angle theta",30);#入射角theta
#set("angle phi",0);#入射角phi
set("polarization angle",90);#偏振角
set("phase",-90);#偏振角






#Monitor  Frequency-domain field profile


addprofile;
set("name","z=9.6");
set("monitor type","2D Z-normal");#xy面监视器
set("x",4.56*um);
set("x span",12*um);
set("y",0);
set("y span",12*um);
set("z",9.6*um);

addprofile;
set("name","y=0");
set("monitor type","2D Y-normal");#xz面监视器
set("x",4.56*um);
set("x span",12*um);
set("y",0);
set("z",6*um);
set("z span",13*um);

